<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - NeoMarket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- Updated CSS paths -->
  <link rel="stylesheet" href="../css/reset.css">
  <link rel="stylesheet" href="../css/variables.css">
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/components.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/responsive.css">
  <style>
    .checkout-page {
      padding: var(--space-3xl) 0;
      min-height: 70vh;
    }

    .progress-steps {
      display: flex;
      justify-content: center;
      margin-bottom: var(--space-3xl);
      position: relative;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 25%;
      right: 25%;
      height: 2px;
      background: var(--glass-border);
      z-index: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
      position: relative;
      z-index: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--muted);
      transition: all var(--transition-fast);
    }

    .step.active .step-circle {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }

    .step.completed .step-circle {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: var(--muted);
      font-weight: 600;
    }

    .step.active .step-label {
      color: var(--accent);
    }

    .checkout-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: var(--space-3xl);
      max-width: 1400px;
      margin: 0 auto;
    }

    .checkout-section {
      background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: var(--space-xl);
      backdrop-filter: blur(10px);
      margin-bottom: var(--space-xl);
    }

    .checkout-section h2 {
      font-size: 1.5rem;
      margin-bottom: var(--space-xl);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
    }

    .order-summary-sidebar {
      background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: var(--space-xl);
      height: fit-content;
      position: sticky;
      top: 100px;
      backdrop-filter: blur(10px);
    }

    .summary-item {
      display: flex;
      gap: var(--space-md);
      padding: var(--space-md) 0;
      border-bottom: 1px solid var(--glass-border);
    }

    .summary-item-image {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
    }

    .summary-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .summary-item-info {
      flex: 1;
    }

    .summary-item-title {
      font-size: 0.875rem;
      color: var(--text);
      margin-bottom: var(--space-xs);
    }

    .summary-item-meta {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .confirmation-page {
      text-align: center;
      padding: var(--space-3xl);
      background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(10px);
    }

    .success-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--success);
      color: white;
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-xl);
    }

    @media (max-width: 1024px) {
      .checkout-layout {
        grid-template-columns: 1fr;
      }

      .order-summary-sidebar {
        position: static;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .progress-steps {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="main-nav" id="mainNav">
    <div class="nav-container">
      <div class="nav-left">
        <a href="index.html" class="logo">
          <span class="logo-icon">◆</span>
          <span class="logo-text">NeoMarket</span>
        </a>
      </div>
      
      <div class="nav-center">
        <div class="search-bar">
          <input type="search" id="navSearch" placeholder="Search gaming hardware..." aria-label="Search products">
          <button class="search-btn" aria-label="Search">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM18 18l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="nav-right">
        <a href="cart.html" class="icon-btn cart-btn" aria-label="Shopping cart">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 2L7 6M17 6l-2-4M6 6h12l1 13H5L6 6zM9 11v5M15 11v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="badge" id="cartBadge">0</span>
        </a>
        <div class="profile-menu">
          <button class="icon-btn profile-btn" id="profileBtn" aria-label="User menu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
              <path d="M4 20c0-4 3.5-7 8-7s8 3 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="profileDropdown" style="display: none;">
            <div id="authMenu"></div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Checkout Page -->
  <section class="checkout-page">
    <div class="container">
      <h1 style="margin-bottom: var(--space-2xl); text-align: center;">Checkout</h1>

      <!-- Progress Steps -->
      <div class="progress-steps">
        <div class="step active" id="step1">
          <div class="step-circle">1</div>
          <div class="step-label">Shipping</div>
        </div>
        <div class="step" id="step2">
          <div class="step-circle">2</div>
          <div class="step-label">Payment</div>
        </div>
        <div class="step" id="step3">
          <div class="step-circle">3</div>
          <div class="step-label">Review</div>
        </div>
        <div class="step" id="step4">
          <div class="step-circle">4</div>
          <div class="step-label">Complete</div>
        </div>
      </div>

      <div id="checkoutContent">
        <!-- Content will be dynamically inserted -->
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="main-footer">
    <div class="container">
      <div class="footer-bottom">
        <p>&copy; 2025 NeoMarket. Pure HTML/CSS/JS Project.</p>
      </div>
    </div>
  </footer>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Updated JS paths -->
  <script src="../js/config.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/toasts.js"></script>
  <script src="../js/modals.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/cart.js"></script>
  <script src="../js/wishlist.js"></script>
  <script src="../js/products.js"></script>
  <script src="../js/main.js"></script>
  <script>
    let currentStep = 1;
    let checkoutData = {
      shipping: {},
      payment: {},
    };

    function initCheckout() {
      const cartItems = getCartWithProducts();
      
      if (cartItems.length === 0) {
        window.location.href = 'cart.html';
        return;
      }

      renderStep(1);
    }

    function renderStep(step) {
      currentStep = step;
      updateProgressSteps();

      const content = document.getElementById('checkoutContent');
      
      switch(step) {
        case 1:
          content.innerHTML = renderShippingStep();
          break;
        case 2:
          content.innerHTML = renderPaymentStep();
          break;
        case 3:
          content.innerHTML = renderReviewStep();
          break;
        case 4:
          content.innerHTML = renderConfirmationStep();
          break;
      }
    }

    function updateProgressSteps() {
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`step${i}`);
        stepEl.classList.remove('active', 'completed');
        
        if (i < currentStep) {
          stepEl.classList.add('completed');
          stepEl.querySelector('.step-circle').textContent = '✓';
        } else if (i === currentStep) {
          stepEl.classList.add('active');
          stepEl.querySelector('.step-circle').textContent = i;
        } else {
          stepEl.querySelector('.step-circle').textContent = i;
        }
      }
    }

    function renderOrderSummary() {
      const cartItems = getCartWithProducts();
      const subtotal = cartItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
      const shipping = subtotal > 500 ? 0 : 15.99;
      const tax = subtotal * 0.08;
      const total = subtotal + shipping + tax;

      return `
        <div class="order-summary-sidebar">
          <h2>Order Summary</h2>
          ${cartItems.map(item => `
            <div class="summary-item">
              <div class="summary-item-image">
                <img src="${item.product.primaryImage}" alt="${escapeHtml(item.product.title)}">
              </div>
              <div class="summary-item-info">
                <div class="summary-item-title">${escapeHtml(truncate(item.product.title, 40))}</div>
                <div class="summary-item-meta">Qty: ${item.quantity} × ${formatCurrency(item.product.price)}</div>
              </div>
            </div>
          `).join('')}
          <div class="summary-row" style="margin-top: var(--space-lg);">
            <span class="summary-label">Subtotal:</span>
            <span class="summary-value">${formatCurrency(subtotal)}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipping:</span>
            <span class="summary-value">${shipping === 0 ? 'FREE' : formatCurrency(shipping)}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Tax:</span>
            <span class="summary-value">${formatCurrency(tax)}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total:</span>
            <span class="summary-total">${formatCurrency(total)}</span>
          </div>
        </div>
      `;
    }

    function renderShippingStep() {
      return `
        <div class="checkout-layout">
          <div>
            <form class="checkout-section" id="shippingForm" onsubmit="submitShipping(event)">
              <h2>Shipping Address</h2>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">First Name *</label>
                  <input type="text" class="form-input" name="firstName" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Last Name *</label>
                  <input type="text" class="form-input" name="lastName" required>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" class="form-input" name="email" required>
              </div>
              <div class="form-group">
                <label class="form-label">Phone Number *</label>
                <input type="tel" class="form-input" name="phone" required>
              </div>
              <div class="form-group">
                <label class="form-label">Address Line 1 *</label>
                <input type="text" class="form-input" name="address1" required>
              </div>
              <div class="form-group">
                <label class="form-label">Address Line 2</label>
                <input type="text" class="form-input" name="address2">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">City *</label>
                  <input type="text" class="form-input" name="city" required>
                </div>
                <div class="form-group">
                  <label class="form-label">State/Province *</label>
                  <input type="text" class="form-input" name="state" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">ZIP/Postal Code *</label>
                  <input type="text" class="form-input" name="zip" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Country *</label>
                  <input type="text" class="form-input" name="country" value="United States" required>
                </div>
              </div>
              <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                <button type="button" class="btn btn-outline" onclick="window.location.href='cart.html'">Back to Cart</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Continue to Payment</button>
              </div>
            </form>
          </div>
          ${renderOrderSummary()}
        </div>
      `;
    }

    function renderPaymentStep() {
      return `
        <div class="checkout-layout">
          <div>
            <form class="checkout-section" id="paymentForm" onsubmit="submitPayment(event)">
              <h2>Payment Method</h2>
              <div style="background: rgba(255, 184, 107, 0.1); border: 1px solid var(--warning); border-radius: var(--radius-sm); padding: var(--space-md); margin-bottom: var(--space-xl); color: var(--warning);">
                <strong>Test Mode:</strong> This is a demonstration. Use any card details.
              </div>
              <div class="form-group">
                <label class="form-label">Card Number *</label>
                <input type="text" class="form-input" name="cardNumber" placeholder="1234 5678 9012 3456" required>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Expiry Date *</label>
                  <input type="text" class="form-input" name="expiry" placeholder="MM/YY" required>
                </div>
                <div class="form-group">
                  <label class="form-label">CVV *</label>
                  <input type="text" class="form-input" name="cvv" placeholder="123" required>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Cardholder Name *</label>
                <input type="text" class="form-input" name="cardName" required>
              </div>
              <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                <button type="button" class="btn btn-outline" onclick="renderStep(1)">Back</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Review Order</button>
              </div>
            </form>
          </div>
          ${renderOrderSummary()}
        </div>
      `;
    }

    function renderReviewStep() {
      const cartItems = getCartWithProducts();
      const subtotal = cartItems.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
      const shipping = subtotal > 500 ? 0 : 15.99;
      const tax = subtotal * 0.08;
      const total = subtotal + shipping + tax;

      return `
        <div class="checkout-layout">
          <div>
            <div class="checkout-section">
              <h2>Review Your Order</h2>
              
              <h3 style="margin-bottom: var(--space-md);">Shipping Address</h3>
              <div style="background: rgba(0, 0, 0, 0.3); padding: var(--space-lg); border-radius: var(--radius-sm); margin-bottom: var(--space-xl);">
                <p style="color: var(--text);">${checkoutData.shipping.firstName} ${checkoutData.shipping.lastName}</p>
                <p style="color: var(--muted);">${checkoutData.shipping.address1}</p>
                ${checkoutData.shipping.address2 ? `<p style="color: var(--muted);">${checkoutData.shipping.address2}</p>` : ''}
                <p style="color: var(--muted);">${checkoutData.shipping.city}, ${checkoutData.shipping.state} ${checkoutData.shipping.zip}</p>
                <p style="color: var(--muted);">${checkoutData.shipping.country}</p>
                <p style="color: var(--muted); margin-top: var(--space-sm);">Phone: ${checkoutData.shipping.phone}</p>
                <p style="color: var(--muted);">Email: ${checkoutData.shipping.email}</p>
              </div>

              <h3 style="margin-bottom: var(--space-md);">Payment Method</h3>
              <div style="background: rgba(0, 0, 0, 0.3); padding: var(--space-lg); border-radius: var(--radius-sm); margin-bottom: var(--space-xl);">
                <p style="color: var(--text);">Card ending in ${checkoutData.payment.cardNumber.slice(-4)}</p>
                <p style="color: var(--muted);">${checkoutData.payment.cardName}</p>
              </div>

              <h3 style="margin-bottom: var(--space-md);">Order Items</h3>
              ${cartItems.map(item => `
                <div style="display: flex; gap: var(--space-md); padding: var(--space-md); border-bottom: 1px solid var(--glass-border);">
                  <img src="${item.product.primaryImage}" alt="${escapeHtml(item.product.title)}" style="width: 60px; height: 60px; border-radius: var(--radius-sm); object-fit: cover;">
                  <div style="flex: 1;">
                    <div style="color: var(--text); margin-bottom: var(--space-xs);">${escapeHtml(item.product.title)}</div>
                    <div style="color: var(--muted); font-size: 0.875rem;">Qty: ${item.quantity}</div>
                  </div>
                  <div style="color: var(--accent); font-weight: 700;">${formatCurrency(item.product.price * item.quantity)}</div>
                </div>
              `).join('')}

              <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
                <button type="button" class="btn btn-outline" onclick="renderStep(2)">Back</button>
                <button type="button" class="btn btn-primary" onclick="placeOrder()" style="flex: 1;">Place Order</button>
              </div>
            </div>
          </div>
          ${renderOrderSummary()}
        </div>
      `;
    }

    function renderConfirmationStep() {
      const orderNumber = 'ORD-' + Date.now().toString().slice(-8);
      
      return `
        <div class="confirmation-page">
          <div class="success-icon">✓</div>
          <h2 style="margin-bottom: var(--space-md);">Order Confirmed!</h2>
          <p style="color: var(--muted); margin-bottom: var(--space-xl);">
            Thank you for your purchase. Your order has been placed successfully.
          </p>
          <div style="background: var(--surface); border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
            <p style="color: var(--muted); margin-bottom: var(--space-sm);">Order Number</p>
            <p style="font-size: 1.5rem; font-family: var(--font-heading); color: var(--accent);">${orderNumber}</p>
          </div>
          <p style="color: var(--muted); margin-bottom: var(--space-xl);">
            A confirmation email has been sent to ${escapeHtml(checkoutData.shipping.email)}
          </p>
          <div style="display: flex; gap: var(--space-md); justify-content: center;">
            <button class="btn btn-primary" onclick="window.location.href='index.html'">Continue Shopping</button>
            <button class="btn btn-outline" onclick="window.location.href='products.html'">Browse Products</button>
          </div>
        </div>
      `;
    }

    function submitShipping(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      checkoutData.shipping = {};
      for (let [key, value] of formData.entries()) {
        checkoutData.shipping[key] = value;
      }
      
      renderStep(2);
      window.scrollTo(0, 0);
    }

    function submitPayment(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      checkoutData.payment = {};
      for (let [key, value] of formData.entries()) {
        checkoutData.payment[key] = value;
      }
      
      renderStep(3);
      window.scrollTo(0, 0);
    }

    function placeOrder() {
      // Clear cart
      clearCart();
      
      // Move to confirmation
      renderStep(4);
      window.scrollTo(0, 0);
      
      showToast('Order placed successfully!', 'success');
    }

    document.addEventListener('DOMContentLoaded', initCheckout);
  </script>
</body>
</html>
