<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - NeoMarket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- Updated CSS paths -->
  <link rel="stylesheet" href="../css/reset.css">
  <link rel="stylesheet" href="../css/variables.css">
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/components.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/responsive.css">
  <style>
    .admin-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    .admin-sidebar {
      background: var(--surface);
      border-right: 1px solid var(--glass-border);
      padding: var(--space-xl);
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-family: var(--font-heading);
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--accent);
      margin-bottom: var(--space-2xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--glass-border);
    }

    .admin-nav {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .admin-nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      color: var(--muted);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .admin-nav-item:hover {
      background: rgba(0, 230, 195, 0.1);
      color: var(--accent);
    }

    .admin-nav-item.active {
      background: rgba(0, 230, 195, 0.1);
      color: var(--accent);
      border-left: 3px solid var(--accent);
    }

    .admin-main {
      padding: var(--space-2xl);
    }

    .admin-header {
      margin-bottom: var(--space-2xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--glass-border);
    }

    .admin-header h1 {
      font-size: 2rem;
      margin-bottom: var(--space-sm);
    }

    .admin-alert {
      background: rgba(255, 77, 87, 0.1);
      border: 1px solid var(--error);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
      color: var(--error);
    }

    .admin-section {
      display: none;
    }

    .admin-section.active {
      display: block;
    }

    .data-table {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .data-table thead {
      background: rgba(0, 0, 0, 0.3);
    }

    .data-table th {
      padding: var(--space-lg);
      text-align: left;
      font-weight: 700;
      color: var(--text);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--glass-border);
    }

    .data-table td {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--glass-border);
      color: var(--muted);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tbody tr {
      transition: background var(--transition-fast);
    }

    .data-table tbody tr:hover {
      background: rgba(0, 230, 195, 0.05);
    }

    .product-thumb {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      background: rgba(0, 0, 0, 0.3);
    }

    .status-badge {
      padding: var(--space-xs) var(--space-md);
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-active {
      background: rgba(45, 211, 111, 0.2);
      color: var(--success);
    }

    .status-paused {
      background: rgba(255, 184, 107, 0.2);
      color: var(--warning);
    }

    .action-buttons {
      display: flex;
      gap: var(--space-sm);
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      background: var(--surface);
      border: 1px solid var(--glass-border);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .btn-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-icon.danger:hover {
      border-color: var(--error);
      color: var(--error);
      background: rgba(255, 77, 87, 0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: var(--space-xl);
      margin-bottom: var(--space-3xl);
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: var(--space-xl);
      backdrop-filter: blur(10px);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--muted);
      margin-bottom: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2rem;
      font-family: var(--font-heading);
      color: var(--accent);
      font-weight: 700;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
    }

    .form-grid-full {
      grid-column: 1 / -1;
    }

    .modal-form {
      max-height: 70vh;
      overflow-y: auto;
    }

    @media (max-width: 1024px) {
      .admin-layout {
        grid-template-columns: 1fr;
      }

      .admin-sidebar {
        position: static;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--glass-border);
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <a href="index.html" class="admin-logo">
        <span>‚óÜ</span>
        <span>NeoMarket</span>
      </a>
      <nav class="admin-nav">
        <div class="admin-nav-item active" onclick="showSection('dashboard')">
          <span>üìä</span>
          <span>Dashboard</span>
        </div>
        <div class="admin-nav-item" onclick="showSection('products')">
          <span>üì¶</span>
          <span>Products</span>
        </div>
        <div class="admin-nav-item" onclick="showSection('users')">
          <span>üë•</span>
          <span>Users</span>
        </div>
        <div style="margin-top: auto; padding-top: var(--space-2xl); border-top: 1px solid var(--glass-border);">
          <a href="index.html" class="admin-nav-item">
            <span>üè†</span>
            <span>Back to Store</span>
          </a>
          <div class="admin-nav-item" onclick="logout()">
            <span>üö™</span>
            <span>Logout</span>
          </div>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-alert">
        <strong>Administrator Access Only</strong> - You have full control over the marketplace.
      </div>

      <!-- Dashboard Section -->
      <section class="admin-section active" id="section-dashboard">
        <div class="admin-header">
          <h1>Dashboard</h1>
          <p style="color: var(--muted);">Overview of your marketplace</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Products</div>
            <div class="stat-value" id="stat-products">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="stat-users">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Sellers</div>
            <div class="stat-value" id="stat-sellers">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Categories</div>
            <div class="stat-value" id="stat-categories">5</div>
          </div>
        </div>
      </section>

      <!-- Products Section -->
      <section class="admin-section" id="section-products">
        <div class="admin-header">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h1>Products</h1>
              <p style="color: var(--muted);">Manage all marketplace products</p>
            </div>
            <button class="btn btn-primary" onclick="openAddProductModal()">
              Add New Product
            </button>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Brand</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <!-- Products will be dynamically inserted -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Users Section -->
      <section class="admin-section" id="section-users">
        <div class="admin-header">
          <h1>Users</h1>
          <p style="color: var(--muted);">Manage user accounts</p>
        </div>

        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be dynamically inserted -->
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Add/Edit Product Modal -->
  <div class="modal" id="productModal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-lg">
      <button class="modal-close" aria-label="Close">&times;</button>
      <h2 id="productModalTitle" style="margin-bottom: var(--space-xl);">Add New Product</h2>
      <form id="productForm" onsubmit="handleProductSubmit(event)" class="modal-form">
        <input type="hidden" id="productId">
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Product Title *</label>
            <input type="text" class="form-input" id="productTitle" required>
          </div>
          <div class="form-group">
            <label class="form-label">Brand *</label>
            <select class="form-input" id="productBrand" required>
              <option value="">Select brand</option>
              <option value="NVIDIA">NVIDIA</option>
              <option value="AMD">AMD</option>
              <option value="Intel">Intel</option>
              <option value="Logitech">Logitech</option>
              <option value="Razer">Razer</option>
              <option value="Corsair">Corsair</option>
              <option value="ASUS">ASUS</option>
              <option value="Samsung">Samsung</option>
              <option value="Keychron">Keychron</option>
            </select>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Category *</label>
            <select class="form-input" id="productCategory" required>
              <option value="">Select category</option>
              <option value="gpu">Graphics Cards</option>
              <option value="mice">Gaming Mice</option>
              <option value="keyboards">Keyboards</option>
              <option value="monitors">Monitors</option>
              <option value="cpu">Processors</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Model Number *</label>
            <input type="text" class="form-input" id="productModel" required>
          </div>
        </div>

        <div class="form-group form-grid-full">
          <label class="form-label">Description *</label>
          <textarea class="form-input" id="productDescription" rows="3" required></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Price *</label>
            <input type="number" class="form-input" id="productPrice" step="0.01" min="0" required>
          </div>
          <div class="form-group">
            <label class="form-label">Original Price</label>
            <input type="number" class="form-input" id="productOriginalPrice" step="0.01" min="0">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Stock Quantity *</label>
            <input type="number" class="form-input" id="productStock" min="0" required>
          </div>
          <div class="form-group">
            <label class="form-label">Condition *</label>
            <select class="form-input" id="productCondition" required>
              <option value="new">New</option>
              <option value="used">Used</option>
              <option value="refurbished">Refurbished</option>
            </select>
          </div>
        </div>

        <div class="form-group form-grid-full">
          <label class="form-label">Image URL *</label>
          <input type="text" class="form-input" id="productImage" placeholder="/product-image.jpg" required>
        </div>

        <div class="form-group form-grid-full">
          <label class="form-label">Specifications (Key: Value format, one per line)</label>
          <textarea class="form-input" id="productSpecs" rows="4" placeholder="VRAM: 24GB GDDR6X&#10;Core Clock: 2.52 GHz&#10;Interface: PCIe 4.0&#10;Power: 450W"></textarea>
        </div>

        <div style="display: flex; gap: var(--space-md); margin-top: var(--space-xl);">
          <button type="button" class="btn btn-outline" onclick="closeModal('productModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Updated JS paths -->
  <script src="../js/config.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/toasts.js"></script>
  <script src="../js/modals.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/cart.js"></script>
  <script src="../js/wishlist.js"></script>
  <script src="../js/products.js"></script>
  <script src="../js/main.js"></script>
  <script src="../js/admin.js"></script>
  <script>
    // Check admin access
    if (!requireAuth('admin')) {
      // Redirect handled by requireAuth
    }

    function showSection(sectionName) {
      // Update nav items
      document.querySelectorAll('.admin-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Update sections
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`section-${sectionName}`).classList.add('active');

      // Load section data
      if (sectionName === 'products') {
        loadProducts();
      } else if (sectionName === 'users') {
        loadUsers();
      }
    }

    function loadDashboard() {
      const products = getProducts();
      const users = window.users || [];
      const sellers = users.filter(u => u.role === 'seller' || u.role === 'admin').length;

      document.getElementById('stat-products').textContent = products.length;
      document.getElementById('stat-users').textContent = users.length;
      document.getElementById('stat-sellers').textContent = sellers;
    }

    function loadProducts() {
      const products = getProducts();
      const tbody = document.getElementById('productsTableBody');

      tbody.innerHTML = products.map(product => `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: var(--space-md);">
              <img src="${product.primaryImage}" alt="${escapeHtml(product.title)}" class="product-thumb">
              <div>
                <div style="color: var(--text); font-weight: 600;">${escapeHtml(truncate(product.title, 40))}</div>
                <div style="font-size: 0.75rem; font-family: var(--font-mono);">${product.modelNumber}</div>
              </div>
            </div>
          </td>
          <td>${product.brand}</td>
          <td>${product.category.toUpperCase()}</td>
          <td style="color: var(--accent); font-weight: 700;">${formatCurrency(product.price)}</td>
          <td>${product.stock}</td>
          <td><span class="status-badge status-active">Active</span></td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon" onclick="editProduct('${product.id}')" title="Edit">‚úé</button>
              <button class="btn-icon danger" onclick="deleteProduct('${product.id}')" title="Delete">√ó</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function loadUsers() {
      const users = window.users || [];
      const tbody = document.getElementById('usersTableBody');

      tbody.innerHTML = users.map(user => `
        <tr>
          <td style="color: var(--text); font-weight: 600;">${escapeHtml(user.displayName)}</td>
          <td>${escapeHtml(user.email)}</td>
          <td><span class="status-badge status-active">${user.role}</span></td>
          <td>${formatDate(user.createdAt)}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon" title="Edit">‚úé</button>
              <button class="btn-icon danger" title="Suspend">‚äò</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openAddProductModal() {
      document.getElementById('productModalTitle').textContent = 'Add New Product';
      document.getElementById('productForm').reset();
      document.getElementById('productId').value = '';
      openModal('productModal');
    }

    function editProduct(productId) {
      const product = findProductById(productId);
      if (!product) return;

      document.getElementById('productModalTitle').textContent = 'Edit Product';
      document.getElementById('productId').value = product.id;
      document.getElementById('productTitle').value = product.title;
      document.getElementById('productBrand').value = product.brand;
      document.getElementById('productCategory').value = product.category;
      document.getElementById('productModel').value = product.modelNumber;
      document.getElementById('productDescription').value = product.description;
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productOriginalPrice').value = product.originalPrice || '';
      document.getElementById('productStock').value = product.stock;
      document.getElementById('productCondition').value = product.condition;
      document.getElementById('productImage').value = product.primaryImage;
      
      // Convert specs object to text
      const specsText = Object.entries(product.specs)
        .map(([key, value]) => `${key}: ${value}`)
        .join('\n');
      document.getElementById('productSpecs').value = specsText;

      openModal('productModal');
    }

    function deleteProduct(productId) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      let products = getProducts();
      products = products.filter(p => p.id !== productId);
      saveProducts(products);
      
      showToast('Product deleted successfully', 'success');
      loadProducts();
      loadDashboard();
    }

    function handleProductSubmit(event) {
      event.preventDefault();

      const productId = document.getElementById('productId').value;
      const specsText = document.getElementById('productSpecs').value;
      
      // Parse specs
      const specs = {};
      if (specsText) {
        specsText.split('\n').forEach(line => {
          const [key, value] = line.split(':').map(s => s.trim());
          if (key && value) {
            specs[key] = value;
          }
        });
      }

      const productData = {
        title: document.getElementById('productTitle').value,
        brand: document.getElementById('productBrand').value,
        category: document.getElementById('productCategory').value,
        modelNumber: document.getElementById('productModel').value,
        description: document.getElementById('productDescription').value,
        price: parseFloat(document.getElementById('productPrice').value),
        originalPrice: document.getElementById('productOriginalPrice').value ? 
          parseFloat(document.getElementById('productOriginalPrice').value) : null,
        stock: parseInt(document.getElementById('productStock').value),
        condition: document.getElementById('productCondition').value,
        primaryImage: document.getElementById('productImage').value,
        images: [document.getElementById('productImage').value],
        specs: specs,
        rating: 4.5,
        reviewCount: Math.floor(Math.random() * 300) + 50,
        vendorId: 'vendor-001',
        vendorName: 'TechGear Pro',
        verified: true,
        warranty: 24,
        shippingFrom: 'US',
        badges: productData.condition === 'new' ? ['new'] : []
      };

      let products = getProducts();

      if (productId) {
        // Update existing product
        const index = products.findIndex(p => p.id === productId);
        if (index !== -1) {
          products[index] = { ...products[index], ...productData };
          showToast('Product updated successfully', 'success');
        }
      } else {
        // Add new product
        productData.id = generateId('prod');
        products.push(productData);
        showToast('Product added successfully', 'success');
      }

      saveProducts(products);
      closeModal('productModal');
      loadProducts();
      loadDashboard();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      loadProducts();
    });
  </script>
</body>
</html>
